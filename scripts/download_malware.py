#!/usr/bin/env python3
"""
MalwareBazaar Downloader with API Key Support
"""
import requests
import os
import zipfile
import time
import json
from pathlib import Path
import argparse
import sys

class MalwareBazaarDownloader:
    def __init__(self, api_key=None, base_dir="data/malware_raw"):
        self.api_key = api_key
        self.base_dir = Path(base_dir)
        self.base_dir.mkdir(parents=True, exist_ok=True)
        
        # Headers with API key if provided
        self.headers = {}
        if api_key:
            self.headers['API-KEY'] = api_key
            print("ðŸ”‘ Using provided API key")
        else:
            print("âš ï¸  No API key provided - using public access (may be limited)")
        
        # Safety limits
        self.max_downloads = 20
        self.min_file_size = 10240  # 10KB
        self.max_file_size = 5242880  # 5MB
    
    def query_recent_samples(self, limit=10):
        """Query recent samples from MalwareBazaar"""
        print(f"ðŸ” Querying for {limit} recent PE samples...")
        
        payload = {
            'query': 'get_recent',
            'selector': 'time',
            'limit': limit * 2  # Get extra to account for filtering
        }
        
        try:
            response = requests.post(
                'https://mb-api.abuse.ch/api/v1/',
                data=payload,
                headers=self.headers,
                timeout=30
            )
            
            print(f"ðŸ“¡ HTTP Status: {response.status_code}")
            
            if response.status_code == 401:
                print("âŒ 401 Unauthorized - Invalid or missing API key")
                return None
            elif response.status_code == 403:
                print("âŒ 403 Forbidden - API key may need activation or have restrictions")
                return None
            elif response.status_code == 429:
                print("âŒ 429 Too Many Requests - Rate limited, try again later")
                return None
            
            response.raise_for_status()
            data = response.json()
            
            if 'query_status' not in data:
                print("âŒ Unexpected API response format")
                return None
                
            if data['query_status'] != 'ok':
                print(f"âŒ API error: {data['query_status']}")
                return None
                
            return data['data']
            
        except requests.exceptions.RequestException as e:
            print(f"âŒ Network error: {e}")
            return None
    
    def filter_pe_samples(self, samples, limit):
        """Filter to only PE files that meet criteria"""
        filtered = []
        
        for sample in samples:
            if len(filtered) >= limit:
                break
                
            file_type = sample.get('file_type', '').lower()
            file_size = sample.get('file_size', 0)
            sha256 = sample.get('sha256_hash')
            
            # Check if it's a PE file
            is_pe = any(pe_indicator in file_type for pe_indicator in 
                       ['pe32', 'exe', 'dll', 'msi'])
            
            # Check file size
            good_size = self.min_file_size <= file_size <= self.max_file_size
            
            if is_pe and good_size and sha256:
                filtered.append(sample)
        
        return filtered
    
    def download_sample(self, sample):
        """Download a single sample"""
        sha256 = sample['sha256_hash']
        output_file = self.base_dir / f"{sha256}.exe"
        
        if output_file.exists():
            print(f"â­ï¸  Already exists: {sha256[:16]}")
            return True
        
        print(f"ðŸ“¥ Downloading {sha256[:16]}...")
        
        try:
            payload = {
                'query': 'get_file',
                'sha256_hash': sha256
            }
            
            response = requests.post(
                'https://mb-api.abuse.ch/api/v1/',
                data=payload,
                headers=self.headers,
                timeout=60,
                stream=True
            )
            
            if response.status_code == 200:
                # Save as temporary zip
                zip_path = output_file.with_suffix('.zip')
                with open(zip_path, 'wb') as f:
                    for chunk in response.iter_content(chunk_size=8192):
                        if chunk:
                            f.write(chunk)
                
                # Extract with password
                success = self.extract_sample(zip_path, output_file)
                
                # Clean up
                if zip_path.exists():
                    zip_path.unlink()
                
                if success and self.verify_sample(output_file, sha256):
                    file_size = output_file.stat().st_size
                    print(f"    âœ… Saved: {file_size:,} bytes")
                    return True
                else:
                    if output_file.exists():
                        output_file.unlink()
                    print(f"    âŒ Extraction/verification failed")
                    return False
            else:
                print(f"    âŒ Download failed: HTTP {response.status_code}")
                return False
                
        except Exception as e:
            print(f"    âŒ Error: {e}")
            return False
    
    def extract_sample(self, zip_path, output_file):
        """Extract sample from password-protected zip"""
        try:
            with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                # Try common passwords
                for password in [b'infected', b'123456', b'']:
                    try:
                        file_list = zip_ref.namelist()
                        if file_list:
                            extracted_data = zip_ref.read(file_list[0], pwd=password)
                            with open(output_file, 'wb') as f:
                                f.write(extracted_data)
                            return True
                    except (RuntimeError, zipfile.BadZipFile):
                        continue
            return False
        except Exception as e:
            print(f"      Extraction error: {e}")
            return False
    
    def verify_sample(self, file_path, expected_sha256):
        """Verify file integrity"""
        import hashlib
        
        if not file_path.exists():
            return False
        
        sha256_hash = hashlib.sha256()
        with open(file_path, 'rb') as f:
            for chunk in iter(lambda: f.read(4096), b""):
                sha256_hash.update(chunk)
        
        return sha256_hash.hexdigest() == expected_sha256
    
    def download_samples(self, limit=10):
        """Main download workflow"""
        print("ðŸš€ MalwareBazaar Downloader")
        print("âš ï¸  WARNING: Handling real malware - use with caution!")
        print("")
        
        # Query samples
        samples = self.query_recent_samples(limit)
        if not samples:
            return 0
        
        print(f"ðŸ“Š Found {len(samples)} total samples")
        
        # Filter to PE files
        pe_samples = self.filter_pe_samples(samples, limit)
        print(f"ðŸ” Filtered to {len(pe_samples)} suitable PE samples")
        
        if not pe_samples:
            print("âŒ No suitable PE samples found")
            return 0
        
        # Download samples
        downloaded = 0
        for i, sample in enumerate(pe_samples, 1):
            print(f"\n[{i}/{len(pe_samples)}] ", end="")
            
            if self.download_sample(sample):
                downloaded += 1
            
            # Be polite to the API
            time.sleep(2)
        
        # Summary
        print(f"\n{'='*50}")
        print(f"ðŸ“Š FINAL SUMMARY:")
        print(f"   âœ… Successfully downloaded: {downloaded}/{len(pe_samples)}")
        print(f"   ðŸ“ Location: {self.base_dir.absolute()}")
        
        return downloaded

def main():
    parser = argparse.ArgumentParser(description='Download malware samples from MalwareBazaar')
    parser.add_argument('--limit', type=int, default=5, help='Number of samples to download (default: 5)')
    parser.add_argument('--api-key', type=str, help='MalwareBazaar API key')
    parser.add_argument('--output', type=str, default='data/malware_raw', help='Output directory')
    
    args = parser.parse_args()
    
    # Try to get API key from environment if not provided
    api_key = args.api_key or os.getenv('MALWAREBAZAAR_API_KEY')
    
    downloader = MalwareBazaarDownloader(api_key=api_key, base_dir=args.output)
    success_count = downloader.download_samples(limit=args.limit)
    
    if success_count == 0:
        print("\nâŒ No samples downloaded. Possible solutions:")
        print("   1. Get an API key from https://bazaar.abuse.ch/")
        print("   2. Use: python3 download_malware_bazaar.py --api-key YOUR_KEY")
        print("   3. Or set environment: export MALWAREBAZAAR_API_KEY=your_key")
        sys.exit(1)

if __name__ == "__main__":
    main()
